"""
Test Entry Endpoints
Ã–ÄŸrenci test giriÅŸi iÃ§in API'ler
"""

import os
import uuid
import logging
from datetime import datetime, timezone
from typing import Optional, List

from fastapi import APIRouter, HTTPException, Header, status, Depends
from app.core.auth import get_current_user
from pydantic import BaseModel
from dotenv import load_dotenv
from supabase import create_client, Client

load_dotenv()

router = APIRouter()
logger = logging.getLogger(__name__)

# ============================================
# SERVICE ROLE CLIENT
# ============================================
def get_force_admin_client() -> Client:
    """Admin yetkili client"""
    url = os.getenv("SUPABASE_URL")
    key = os.getenv("SUPABASE_SERVICE_KEY")
    
    if not url or not key:
        logger.error("Supabase credentials eksik! .env dosyasÄ±nÄ± kontrol et.")
        raise HTTPException(
            status_code=500, 
            detail="Sunucu yapÄ±landÄ±rma hatasÄ±: Admin anahtarÄ± bulunamadÄ±."
        )
        
    return create_client(url, key)

# ============================================
# REQUEST/RESPONSE MODELS
# ============================================

class TestResultSubmit(BaseModel):
    student_id: str
    subject_id: str
    topic_id: str
    test_date: str
    correct_count: int
    wrong_count: int
    empty_count: int
    net_score: float
    success_rate: float
    test_duration_minutes: Optional[int] = None  # Test sÃ¼resi (dakika) - opsiyonel


# ============================================
# GET /api/v1/subjects
# ============================================

@router.get("/subjects")
async def get_subjects(current_user: dict = Depends(get_current_user)):
    """TÃ¼m dersleri listele"""
    supabase = get_force_admin_client()
    
    try:
        result = supabase.table("subjects").select(
            "id, code, name_tr, icon, color"
        ).eq("is_active", True).order("name_tr").execute()
        
        return result.data
    except Exception as e:
        logger.error(f"Subjects Error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ============================================
# GET /api/v1/subjects/{subject_id}/topics
# ============================================

@router.get("/subjects/{subject_id}/topics")
async def get_topics_by_subject(subject_id: str):
    """Bir derse ait konularÄ± listele"""
    supabase = get_force_admin_client()
    
    try:
        result = supabase.table("topics").select(
            "id, code, name_tr, difficulty_level, exam_weight"
        ).eq("subject_id", subject_id).eq("is_active", True).order("name_tr").execute()
        
        return result.data
    except Exception as e:
        logger.error(f"Topics Error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ============================================
# AUTO-COMPLETE TASK HELPER
# ============================================

def auto_complete_task_if_exists(supabase: Client, student_id: str, topic_id: str, test_result_id: str):
    """
    BugÃ¼nkÃ¼ gÃ¶revlerde bu konu varsa otomatik tamamla
    """
    try:
        today = datetime.now(timezone.utc).date().isoformat()
        
        # BugÃ¼nkÃ¼ gÃ¶revlerde bu topic var mÄ± kontrol et (pending durumda)
        tasks = supabase.table("student_tasks").select("*").eq(
            "student_id", student_id
        ).eq(
            "task_date", today
        ).eq(
            "topic_id", topic_id
        ).eq(
            "status", "pending"
        ).execute()
        
        if tasks.data and len(tasks.data) > 0:
            # Ä°lk eÅŸleÅŸen gÃ¶revi otomatik tamamla
            task = tasks.data[0]
            
            update_data = {
                "status": "completed",
                "completed_at": datetime.now(timezone.utc).isoformat(),
                "manual_completion": False,  # Otomatik tamamlama
                "test_result_id": test_result_id
            }
            
            supabase.table("student_tasks").update(update_data).eq("id", task["id"]).execute()
            
            logger.info(f"âœ… Auto-completed task {task['id']} for topic {topic_id}")
            
            return {
                "auto_completed": True,
                "task_id": task["id"],
                "task_name": task["topic_name"]
            }
        else:
            logger.info(f"â„¹ï¸ No pending task found for topic {topic_id} today")
            return {"auto_completed": False}
            
    except Exception as e:
        logger.error(f"Auto-complete task error: {str(e)}")
        # Hata olsa bile test kaydÄ± baÅŸarÄ±lÄ± olduÄŸu iÃ§in gÃ¶rev tamamlama hatasÄ± dÃ¶nmemeliyiz
        return {"auto_completed": False, "error": str(e)}


# ============================================
# POST /api/v1/test-results
# ============================================

@router.post("/test-results")
async def submit_test_result(
    test_data: TestResultSubmit,
    
):
    """
    Test sonucu kaydet + Otomatik gÃ¶rev tamamlama
    """
    supabase = get_force_admin_client()
    
    try:
        logger.info(f"ğŸ“ Test giriÅŸi baÅŸlÄ±yor: student={test_data.student_id}, topic={test_data.topic_id}")
        
        # Test record hazÄ±rla
        test_record = {
            "student_id": test_data.student_id,
            "subject_id": test_data.subject_id,
            "topic_id": test_data.topic_id,
            "test_date": test_data.test_date,
            "correct_count": test_data.correct_count,
            "wrong_count": test_data.wrong_count,
            "empty_count": test_data.empty_count,
            "net_score": test_data.net_score,
            "success_rate": test_data.success_rate,
            "is_processed": False,
            "processing_status": "pending",
            "test_source": "web_form",
            "test_duration_minutes": test_data.test_duration_minutes,
            "question_type": "multiple_choice",
            "created_via": "web_form",
            "api_version": "v1",
            "request_id": str(uuid.uuid4()),
            "created_at": datetime.utcnow().isoformat()
        }
        
        # Test'i kaydet
        result = supabase.table("student_topic_tests").insert(test_record).execute()
        
        if not result.data:
            logger.warning("âš ï¸ Insert yapÄ±ldÄ± ama data boÅŸ dÃ¶ndÃ¼.")
            return {
                "success": True,
                "message": "Test kaydedildi (Data dÃ¶nÃ¼ÅŸÃ¼ yok)",
                "net_score": test_data.net_score,
                "task_auto_completed": False
            }
        
        # Test baÅŸarÄ±yla kaydedildi, ÅŸimdi otomatik gÃ¶rev tamamlama
        test_id = result.data[0].get("id")
        logger.info(f"âœ… Test kaydedildi: test_id={test_id}")
        
        # Otomatik gÃ¶rev tamamlama dene
        task_result = auto_complete_task_if_exists(
            supabase=supabase,
            student_id=test_data.student_id,
            topic_id=test_data.topic_id,
            test_result_id=test_id
        )
        
        # Response hazÄ±rla
        response = {
            "success": True,
            "message": "Test baÅŸarÄ±yla kaydedildi",
            "test_id": test_id,
            "net_score": test_data.net_score,
            "task_auto_completed": task_result.get("auto_completed", False)
        }
        
        # EÄŸer gÃ¶rev otomatik tamamlandÄ±ysa bilgi ekle
        if task_result.get("auto_completed"):
            response["completed_task"] = {
                "task_id": task_result.get("task_id"),
                "task_name": task_result.get("task_name")
            }
            response["message"] += " ve gÃ¶rev otomatik tamamlandÄ±! ğŸ‰"
        
        return response
        
    except Exception as e:
        logger.error(f"âŒ Test submit error: {str(e)}")
        raise HTTPException(
            status_code=500, 
            detail=f"VeritabanÄ± hatasÄ±: {str(e)}"
        )
