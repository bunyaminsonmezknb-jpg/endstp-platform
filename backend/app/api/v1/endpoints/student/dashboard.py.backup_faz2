"""
Student Dashboard & Profile Endpoints
- Dashboard stats
- Profile
- Tests list
- Weekly subjects
"""
from fastapi import APIRouter, HTTPException, Depends
from typing import Optional, List
from datetime import datetime, timezone, timedelta
from app.db.session import get_supabase_admin
from app.core.auth import get_current_user
from .utils import calculate_remembering_rate, format_turkish_date, calculate_next_review_date, calculate_status, get_mock_topics, calculate_realistic_projection, EXAM_DATE
from .performance import get_student_performance

router = APIRouter()

# Mock data fonksiyonu (geÃ§ici)
def get_mock_dashboard():
    """Mock dashboard data"""
    return {
        "success": True,
        "message": "Mock data - henÃ¼z test giriÅŸi yok",
        "topics": []
    }

@router.get("/dashboard")
async def get_student_dashboard(current_user: dict = Depends(get_current_user)):
    """Ã–ÄŸrenci dashboard verisi (Cache'li performans modÃ¼lÃ¼ ile)"""
    student_id = current_user["id"]
    
    # Cache'li performans modÃ¼lÃ¼
    perf_data = get_student_performance(student_id, use_cache=True)
    topic_performance = perf_data["topic_performance"]
    all_tests = perf_data.get("all_tests", [])
    
    if not all_tests:
        return get_mock_dashboard()
    
    # Topic listesi oluÅŸtur
    topics_list = []
    
    for topic_id, data in topic_performance.items():
        tests = data["tests"]
        
        # Achievement badge
        achievement_badge = None
        if len(tests) >= 2:
            improvement = tests[0].get("success_rate", 0) - tests[-1].get("success_rate", 0)
            if improvement > 20:
                achievement_badge = {
                    "text": f"+%{{int(improvement)}} ({{len(tests)}} test)",
                    "icon": "â­"
                }
        
        # Topic objesi (performance modÃ¼lÃ¼nden hazÄ±r data)
        topic_obj = {
            "id": topic_id,
            "name": data["topic_name"],
            "subject": data["subject_name"],
            "rememberingRate": data["remembering_rate"],
            "status": data["status"],
            "statusText": data["status_text"],
            "emoji": data["emoji"],
            "days_since_last_test": data["days_since_last_test"],
            "total_tests": data["total_tests"],
            "latest_net": data["latest_net"],
            "latest_success_rate": data["latest_success_rate"],
            "next_review": data["next_review"]
        }
        
        if achievement_badge:
            topic_obj["achievementBadge"] = achievement_badge
        
        topics_list.append(topic_obj)
    
    topics_list.sort(key=lambda x: x["rememberingRate"])
    
    # Analytics
    if topics_list:
        worst = topics_list[0]
    else:
        worst = {"rememberingRate": 0}
    
    now = datetime.now(timezone.utc)
    week_ago = now - timedelta(days=7)
    
    weekly_tests = [
        t for t in all_tests 
        if datetime.fromisoformat(t["test_date"].replace('Z', '+00:00')) >= week_ago
    ]
    
    weekly_success = int((sum([t.get("success_rate", 0) for t in weekly_tests]) / len(weekly_tests)) if weekly_tests else 0)
    
    month_ago = now - timedelta(days=30)
    monthly_tests = [
        t for t in all_tests 
        if datetime.fromisoformat(t["test_date"].replace('Z', '+00:00')) >= month_ago
    ]
    
    projection = calculate_realistic_projection(all_tests, topic_performance)
    
    return {
        "success": True,
        "topics": topics_list,
        "analytics": {
            "weakestTopic": worst["rememberingRate"],
            "forgetRisk": 100 - worst["rememberingRate"]
        },
        "weekly": {
            "tests": len(weekly_tests),
            "average_success": weekly_success
        },
        "monthly": {
            "tests": len(monthly_tests)
        },
        "projection": projection,
        "cache_info": perf_data.get("metadata", {})
    }
def get_mock_dashboard():
    """Mock dashboard - Test yoksa boÅŸ dÃ¶ner"""
    return {
        "student_name": "Demo Ã–ÄŸrenci",
        "streak": 0,
        "daily_goal": {"current": 0, "target": 5},
        "weekly_success": 0,
        "weekly_target": 85,
        "study_time_today": 0,
        "weekly_questions": 0,
        "weekly_increase": 0,
        "topics": [],  # â† BOÅž ARRAY
        "critical_alert": None,  # â† NULL
        "projection": None  # â† NULL
    }


@router.get("/profile")
async def get_student_profile(current_user: dict = Depends(get_current_user)):
    return {"id": student_id, "name": "Demo Ã–ÄŸrenci", "email": "demo@endstp.com", "class": "11. SÄ±nÄ±f"}


@router.get("/tests")
async def get_student_tests(current_user: dict = Depends(get_current_user)):
    student_id = current_user["id"]
    """
    Ã–ÄŸrencinin tÃ¼m test geÃ§miÅŸini getir
    """
    supabase = get_supabase_admin()
    
    # Testleri Ã§ek (topic ve subject bilgileriyle)
    tests_response = supabase.table("student_topic_tests").select(
        "*, topics(name_tr, subject_id, subjects(name_tr))"
    ).eq("student_id", student_id).order("test_date", desc=True).execute()
    
    if not tests_response.data:
        return {"tests": []}
    
    # Formatla
    formatted_tests = []
    for test in tests_response.data:
        formatted_tests.append({
            "id": test["id"],
            "test_date": test["test_date"],
            "correct_count": test["correct_count"],
            "wrong_count": test["wrong_count"],
            "empty_count": test["empty_count"],
            "net_score": float(test["net_score"]),
            "success_rate": float(test["success_rate"]),
            "topic": {
                "name_tr": test["topics"]["name_tr"] if test.get("topics") else "Bilinmeyen"
            },
            "subject": {
                "name_tr": test["topics"]["subjects"]["name_tr"] if test.get("topics") and test["topics"].get("subjects") else "Bilinmeyen"
            }
        })
    
    return {"tests": formatted_tests}
@router.get("/weekly-subjects")
async def get_weekly_subjects(current_user: dict = Depends(get_current_user)):
    student_id = current_user["id"]
    """
    Son 7 gÃ¼nÃ¼n ders bazlÄ± performansÄ±
    """
    try:
        supabase = get_supabase_admin()
        
        # Son 7 gÃ¼nÃ¼n testlerini Ã§ek
        week_ago = datetime.now(timezone.utc) - timedelta(days=7)
        
        tests = supabase.table("student_topic_tests").select(
            "*, topics(name_tr, subjects(id, name_tr))"
        ).eq("student_id", student_id).gte("test_date", week_ago.isoformat()).execute()
        
        if not tests.data:
            return {
                "success": True,
                "subjects": [],
                "message": "Son 7 gÃ¼nde test yok"
            }
        
        # Ders bazÄ±nda grupla
        subject_stats = {}
        
        for test in tests.data:
            if not test.get("topics") or not test["topics"].get("subjects"):
                continue
                
            subject_id = test["topics"]["subjects"]["id"]
            subject_name = test["topics"]["subjects"]["name_tr"]
            
            if subject_id not in subject_stats:
                subject_stats[subject_id] = {
                    "name": subject_name,
                    "total_tests": 0,
                    "total_success": 0
                }
            
            subject_stats[subject_id]["total_tests"] += 1
            subject_stats[subject_id]["total_success"] += test["success_rate"]
        
        # Ortalama hesapla
        subjects = []
        for subject_id, stats in subject_stats.items():
            avg_success = int(stats["total_success"] / stats["total_tests"])
            subjects.append({
                "name": stats["name"],
                "avg_success": avg_success,
                "total_tests": stats["total_tests"]
            })
        
        # BaÅŸarÄ±ya gÃ¶re sÄ±rala
        subjects.sort(key=lambda x: x["avg_success"])
        
        # En kÃ¶tÃ¼ 2, en iyi 2
        worst = subjects[:2] if len(subjects) >= 2 else subjects
        best = subjects[-2:] if len(subjects) >= 2 else []
        best.reverse()
        
        return {
            "success": True,
            "worst_subjects": worst,
            "best_subjects": best,
            "all_subjects": subjects
        }
        
    except Exception as e:
        print(f"Weekly subjects error: {str(e)}")
        return {"success": False, "error": str(e)}
# student.py'nin en sonuna ekle

# ============================================
# ðŸ“‹ SUPPORT FEEDBACK ENDPOINTS
# ============================================
